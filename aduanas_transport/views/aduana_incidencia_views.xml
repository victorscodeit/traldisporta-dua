<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <!-- Vista Tree de Incidencias -->
  <record id="view_aduana_incidencia_tree" model="ir.ui.view">
    <field name="name">aduana.incidencia.tree</field>
    <field name="model">aduana.incidencia</field>
    <field name="arch" type="xml">
      <tree string="Incidencias Aduaneras" decoration-danger="state == 'pendiente' and prioridad == 'critica'" decoration-warning="state == 'pendiente' and prioridad == 'alta'" decoration-info="state == 'resuelta'">
        <field name="name"/>
        <field name="expediente_id"/>
        <field name="mrn"/>
        <field name="tipo_incidencia"/>
        <field name="codigo_incidencia"/>
        <field name="titulo"/>
        <field name="prioridad" widget="badge" decoration-danger="prioridad == 'critica'" decoration-warning="prioridad == 'alta'"/>
        <field name="state" widget="badge" decoration-success="state == 'resuelta'" decoration-info="state == 'en_revision'"/>
        <field name="fecha_incidencia"/>
        <field name="dias_pendiente"/>
        <field name="origen"/>
      </tree>
    </field>
  </record>

  <!-- Vista Form de Incidencias -->
  <record id="view_aduana_incidencia_form" model="ir.ui.view">
    <field name="name">aduana.incidencia.form</field>
    <field name="model">aduana.incidencia</field>
    <field name="arch" type="xml">
      <form string="Incidencia Aduanera">
        <header>
          <button name="action_marcar_resuelta" string="Marcar como Resuelta" type="object"
                  class="oe_highlight" attrs="{'invisible': [('state', 'in', ['resuelta', 'cerrada', 'rechazada'])]}"/>
          <button name="action_marcar_cerrada" string="Cerrar" type="object"
                  attrs="{'invisible': [('state', 'in', ['cerrada', 'rechazada'])]}"/>
          <button name="action_ver_expediente" string="Ver Expediente" type="object"/>
          <field name="state" widget="statusbar" statusbar_visible="pendiente,en_revision,resuelta,cerrada,rechazada"/>
        </header>
        <sheet>
          <div class="oe_button_box" name="button_box">
            <button name="action_ver_expediente" type="object" class="oe_stat_button" icon="fa-file-text-o">
              <field name="expediente_id" widget="statinfo" string="Expediente"/>
            </button>
          </div>
          <group>
            <group>
              <field name="name"/>
              <field name="expediente_id" options="{'no_create': True, 'no_create_edit': True}"/>
              <field name="mrn" readonly="1"/>
              <field name="tipo_incidencia"/>
              <field name="codigo_incidencia"/>
              <field name="prioridad" widget="badge"/>
            </group>
            <group>
              <field name="origen"/>
              <field name="fecha_incidencia"/>
              <field name="fecha_deteccion" readonly="1"/>
              <field name="fecha_resolucion" readonly="1"/>
              <field name="dias_pendiente" readonly="1"/>
              <field name="usuario_resolucion" readonly="1"/>
            </group>
          </group>
          
          <group string="Descripción">
            <field name="titulo" placeholder="Título de la incidencia..."/>
            <field name="descripcion" placeholder="Descripción detallada de la incidencia..." nolabel="1"/>
          </group>
          
          <group string="Mensaje Original AEAT" attrs="{'invisible': [('mensaje_aeat', '=', False)]}">
            <field name="mensaje_aeat" readonly="1" nolabel="1" widget="text"/>
          </group>
          
          <group string="Resolución" attrs="{'invisible': [('state', 'in', ['pendiente', 'en_revision'])]}">
            <field name="resolucion" placeholder="Descripción de cómo se resolvió..." nolabel="1"/>
            <field name="accion_tomada" placeholder="Acciones realizadas para resolver..." nolabel="1"/>
          </group>
          
          <group string="Archivos Adjuntos">
            <field name="attachment_ids" nolabel="1"/>
          </group>
        </sheet>
        <div class="oe_chatter">
          <field name="message_follower_ids" widget="mail_followers"/>
          <field name="activity_ids" widget="mail_activity"/>
          <field name="message_ids" widget="mail_thread"/>
        </div>
      </form>
    </field>
  </record>

  <!-- Vista Search de Incidencias -->
  <record id="view_aduana_incidencia_search" model="ir.ui.view">
    <field name="name">aduana.incidencia.search</field>
    <field name="model">aduana.incidencia</field>
    <field name="arch" type="xml">
      <search string="Buscar Incidencias">
        <field name="name"/>
        <field name="expediente_id"/>
        <field name="mrn"/>
        <field name="codigo_incidencia"/>
        <field name="titulo"/>
        <filter string="Pendientes" name="pending" domain="[('state', 'in', ('pendiente', 'en_revision'))]"/>
        <filter string="Críticas" name="critical" domain="[('prioridad', '=', 'critica')]"/>
        <filter string="Resueltas" name="resolved" domain="[('state', '=', 'resuelta')]"/>
        <filter string="Hoy" name="today" domain="[('fecha_incidencia', '>=', datetime.combine(context_today(), time.min)), ('fecha_incidencia', '&lt;=', datetime.combine(context_today(), time.max))]"/>
        <filter string="Esta Semana" name="this_week" domain="[('fecha_incidencia', '>=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
        <group expand="0" string="Agrupar por">
          <filter string="Estado" name="group_by_state" context="{'group_by': 'state'}"/>
          <filter string="Prioridad" name="group_by_prioridad" context="{'group_by': 'prioridad'}"/>
          <filter string="Tipo" name="group_by_tipo" context="{'group_by': 'tipo_incidencia'}"/>
          <filter string="Origen" name="group_by_origen" context="{'group_by': 'origen'}"/>
          <filter string="Expediente" name="group_by_expediente" context="{'group_by': 'expediente_id'}"/>
          <filter string="Fecha" name="group_by_fecha" context="{'group_by': 'fecha_incidencia'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- Acción para Incidencias -->
  <record id="action_aduana_incidencia" model="ir.actions.act_window">
    <field name="name">Incidencias Aduaneras</field>
    <field name="res_model">aduana.incidencia</field>
    <field name="view_mode">tree,form</field>
    <field name="context">{'search_default_pending': 1}</field>
    <field name="search_view_id" ref="view_aduana_incidencia_search"/>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        No hay incidencias registradas
      </p>
      <p>
        Las incidencias se crean automáticamente cuando AEAT comunica errores, advertencias o requerimientos.
      </p>
    </field>
  </record>

  <!-- Menú -->
  <menuitem id="menu_aduanas_incidencias" name="Incidencias" parent="menu_aduanas_root" action="action_aduana_incidencia" sequence="20"/>


</odoo>

