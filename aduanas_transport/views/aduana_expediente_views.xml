<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <!-- Lista -->
  <record id="view_aduana_expediente_tree" model="ir.ui.view">
    <field name="name">aduana.expediente.tree</field>
    <field name="model">aduana.expediente</field>
    <field name="arch" type="xml">
      <tree string="Expedientes Aduaneros" default_order="create_date desc" create="1" js_class="expediente_list_button">
        <field name="name" string="Código/Referencia"/>
        <field name="factura_estado_procesamiento" widget="badge" 
               decoration-success="factura_estado_procesamiento == 'completado'" 
               decoration-warning="factura_estado_procesamiento == 'advertencia'" 
               decoration-info="factura_estado_procesamiento == 'procesando'" 
               decoration-muted="factura_estado_procesamiento == 'sin_factura'"
               decoration-danger="factura_estado_procesamiento == 'error'"
               string="Estado Factura"/>
        <field name="verificacion_ia_estado" widget="badge" 
               decoration-success="verificacion_ia_estado == 'ok'"
               decoration-warning="verificacion_ia_estado == 'advertencia'"
               decoration-danger="verificacion_ia_estado == 'critico'"
               decoration-muted="verificacion_ia_estado == 'pendiente'"
               string="Verif. IA"
               invisible="context.get('hide_verificacion_ia', False)"/>
        <field name="matricula"/>
        <field name="direction"/>
        <field name="remitente"/>
        <field name="consignatario"/>
        <field name="oficina"/>
        <field name="mrn"/>
        <field name="state" widget="badge" decoration-success="state == 'closed'" decoration-info="state == 'accepted'" decoration-warning="state in ('draft', 'predeclared', 'presented', 'released')" decoration-danger="state == 'error'"/>
        <field name="create_date" string="Fecha creación"/>
      </tree>
    </field>
  </record>

  <!-- Formulario -->
  <record id="view_aduana_expediente_form" model="ir.ui.view">
    <field name="name">aduana.expediente.form</field>
    <field name="model">aduana.expediente</field>
    <field name="arch" type="xml">
      <form string="Expediente Aduanero">
        <header>
          <!-- Botones principales en orden: Procesar Factura, Verificación IA, Generar DUA, Consultar bandeja -->
          <button name="action_process_invoice_pdf" string="Procesar Factura PDF" type="object"
                  class="oe_highlight"
                  attrs="{'invisible': ['|', ('factura_pdf', '=', False), ('factura_procesada', '=', True)]}"
                  help="Extrae datos de la factura PDF usando IA/OCR"/>
          <button name="action_realizar_verificacion_ia" string="Realizar Verificación IA" type="object"
                  class="oe_highlight"
                  attrs="{'invisible': [('line_ids', '=', [])]}"
                  help="Realiza una verificación IA de las partidas arancelarias y coherencia de las líneas del expediente. Normaliza las partidas a 10 dígitos."/>
          <button name="action_generate_dua" string="Generar DUA" type="object"
                  class="oe_highlight"
                  attrs="{'invisible': ['|', ('direction', '!=', 'export'), ('dua_generado', '=', True)]}"
                  help="Genera el DUA de exportación (CUSDEC EX1). Conviene tener factura procesada o líneas rellenadas."/>
          <button name="action_generate_dua" string="Regenerar DUA" type="object"
                  class="oe_highlight"
                  attrs="{'invisible': ['|', ('direction', '!=', 'export'), ('dua_generado', '=', False)]}"
                  help="Regenera el DUA de exportación (CUSDEC EX1)"/>
          <button name="action_send_cc515c" string="Presentar DUA a AEAT" type="object"
                  class="oe_highlight"
                  attrs="{'invisible': ['|', '|', ('direction', '!=', 'export'), ('dua_generado', '=', False), ('state', '=', 'accepted')]}"
                  help="Envía el DUA (CUSDEC EX1) al endpoint configurado. Por defecto preproducción. Configurar en Aduanas &gt; Configuración."/>
          <button name="action_poll_bandeja" string="Consultar Bandeja" type="object" invisible="1"/>
          
          <!-- Botones adicionales de exportación (ocultos) -->
          <button name="action_generate_cc515c" string="(Export) Generar CC515C" type="object"
                  class="oe_highlight"
                  invisible="1"/>
          <button name="action_present_cc511c" string="(Export) Presentar CC511C" type="object"
                  invisible="1"/>
          <button name="action_preview_cc511c" string="(Export) Previsualizar CC511C" type="object"
                  invisible="1"/>
          <button name="action_presentar_exs_preprod" string="Presentar EXS (preproducción)" type="object"
                  class="oe_highlight"
                  invisible="1"
                  help="Presenta la Declaración Sumaria de Salida (EXS) al endpoint de preproducción IE615 V5 (oculto por el momento)"/>

          <!-- Botones de importación -->
          <button name="action_generate_imp_decl" string="(Import) Generar Declaración" type="object"
                  class="oe_highlight"
                  attrs="{'invisible': [('direction', '!=', 'import')]}"/>
          <button name="action_send_imp_decl" string="(Import) Enviar Declaración" type="object"
                  attrs="{'invisible': [('direction', '!=', 'import')]}"/>
          <button name="action_preview_imp_decl" string="(Import) Previsualizar Declaración" type="object"
                  attrs="{'invisible': ['|', ('id', '=', False), ('direction', '!=', 'import')]}"/>

          <field name="state" widget="statusbar"
                 statusbar_visible="draft,predeclared,presented,accepted,released,exited,closed,error"/>
        </header>

        <sheet>
          <div class="oe_button_box" name="button_box">
            <button name="action_view_incidencias" type="object" class="oe_stat_button" context="{'search_default_expediente_id': active_id}">
              <field name="incidencias_count" widget="statinfo" string="Incidencias"/>
            </button>
            <button name="action_view_incidencias_pendientes" type="object" class="oe_stat_button" context="{'search_default_expediente_id': active_id, 'search_default_pending': 1}">
              <field name="incidencias_pendientes_count" widget="statinfo" string="Pendientes"/>
            </button>
          </div>
          
          <!-- Campos necesarios para attrs del header (invisibles) -->
          <field name="dua_generado" invisible="1"/>
          <field name="factura_procesada" invisible="1"/>
          <field name="factura_pdf" invisible="1"/>
          
          <!-- FACTURAS DEL EXPEDIENTE -->
          <group string="Facturas" colspan="2">
            <button name="action_subir_facturas" string="Subir facturas" type="object"
                    class="oe_highlight"
                    icon="fa-upload"
                    help="Sube múltiples facturas PDF de golpe y las añade a este expediente"/>
            <button name="action_procesar_todas_facturas" 
                    string="Procesar facturas" 
                    type="object"
                    class="oe_highlight"
                    icon="fa-cog"
                    attrs="{'invisible': [('factura_ids', '=', [])]}"
                    help="Procesa todas las facturas pendientes del expediente"/>
            <field name="factura_ids" nolabel="1" colspan="2"
                   context="{'default_expediente_id': id}">
              <tree>
                <field name="name"/>
                <field name="factura_procesada" column_invisible="1"/>
                <field name="factura_pdf_filename"/>
                <field name="factura_estado_procesamiento" widget="badge"
                       decoration-success="factura_estado_procesamiento == 'completado'"
                       decoration-warning="factura_estado_procesamiento == 'advertencia'"
                       decoration-info="factura_estado_procesamiento == 'procesando'"
                       decoration-muted="factura_estado_procesamiento in ('sin_factura', 'pendiente')"
                       decoration-danger="factura_estado_procesamiento == 'error'"/>
                <field name="lineas_count" string="Nº Líneas"/>
                <field name="fecha_procesamiento"/>
                <button name="action_process_invoice_pdf" string="Procesar" type="object"
                        attrs="{'invisible': ['|', ('factura_procesada', '=', True), ('factura_estado_procesamiento', '==', 'procesando')]}"
                        icon="fa-play"/>
                <button name="action_view_lineas" string="Ver Líneas" type="object"
                        attrs="{'invisible': [('lineas_count', '=', 0)]}"
                        icon="fa-list"/>
              </tree>
              <form>
                <sheet>
                  <group>
                    <field name="name"/>
                    <field name="expediente_id" readonly="1"/>
                    <field name="factura_pdf" filename="factura_pdf_filename" widget="binary" required="1"/>
                    <field name="factura_pdf_filename"/>
                    <field name="factura_estado_procesamiento" widget="statusbar" 
                           statusbar_visible="sin_factura,pendiente,procesando,completado,advertencia,error"/>
                    <field name="factura_procesada" invisible="1"/>
                    <field name="fecha_procesamiento" readonly="1"/>
                  </group>
                  <group colspan="2" attrs="{'invisible': [('factura_mensaje_html', '=', False)]}">
                    <field name="factura_mensaje_html" nolabel="1" readonly="1" 
                           widget="html"
                           colspan="2"
                           style="width: 100%;"/>
                  </group>
                  <group colspan="2" attrs="{'invisible': [('factura_mensaje_error', '=', False)]}">
                    <field name="factura_mensaje_error" nolabel="1" readonly="1" 
                           widget="text"
                           colspan="2"/>
                  </group>
                </sheet>
              </form>
            </field>
          </group>
          
          <!-- RESUMEN VERIFICACIÓN IA -->
          <group string="Verificación IA" col="2" attrs="{'invisible': [('line_ids', '=', [])]}">
            <group>
              <field name="verificacion_ia_resumen" readonly="1" nolabel="1" 
                     widget="text" 
                     placeholder="Ejecuta la verificación IA para ver el resumen"/>
            </group>
            <group>
              <field name="verificacion_ia_estado" widget="badge" 
                     decoration-success="verificacion_ia_estado == 'ok'"
                     decoration-warning="verificacion_ia_estado == 'advertencia'"
                     decoration-danger="verificacion_ia_estado == 'critico'"
                     decoration-muted="verificacion_ia_estado == 'pendiente'"
                     readonly="1"/>
            </group>
          </group>
          
          <!-- INFORMACIÓN GENERAL -->
          <group string="Información general" col="2">
            <group>
              <field name="name"/>
              <field name="direction"/>
              <field name="state" readonly="1"/>
              <field name="lrn"/>
              <field name="mrn"/>
              <field name="exs_circuito" attrs="{'invisible': [('direction', '!=', 'export')]}"/>
              <field name="exs_tipo_declaracion" attrs="{'invisible': [('direction', '!=', 'export')]}"/>
              <field name="exs_dec_csv" attrs="{'invisible': [('direction', '!=', 'export')]}"/>
              <field name="exs_rel_csv" attrs="{'invisible': [('direction', '!=', 'export')]}"/>
              <field name="exs_predeclaracion" attrs="{'invisible': [('direction', '!=', 'export')]}"/>
            </group>
            <group>
              <field name="remitente"/>
              <field name="consignatario"/>
              <field name="oficina"/>
              <field name="incoterm"/>
              <field name="incoterm_info" nolabel="1" invisible="1"/>
            </group>
          </group>
          
          <group string="Fechas" col="4">
            <field name="fecha_prevista"/>
            <field name="fecha_salida_real"/>
            <field name="fecha_entrada_real"/>
            <field name="fecha_levante"/>
            <field name="fecha_recepcion"/>
          </group>
          
          <group string="Transporte" col="2">
            <group>
              <field name="referencia_transporte"/>
              <field name="matricula"/>
              <field name="transportista"/>
              <field name="remolque"/>
              <field name="codigo_transporte"/>
            </group>
            <group>
              <field name="conductor_nombre"/>
              <field name="conductor_dni"/>
            </group>
          </group>
          
          <group string="Referencias MSoft" col="2" attrs="{'invisible': [('msoft_codigo', '=', False)]}">
            <group>
              <field name="msoft_codigo" readonly="1"/>
              <field name="msoft_recepcion_num" readonly="1"/>
              <field name="msoft_estado_original" readonly="1"/>
              <field name="msoft_sincronizado" readonly="1"/>
            </group>
            <group>
              <field name="msoft_fecha_recepcion" readonly="1"/>
              <field name="msoft_fecha_modificacion" readonly="1"/>
              <field name="msoft_ultima_sincronizacion" readonly="1"/>
              <field name="msoft_usuario_modificacion" readonly="1"/>
            </group>
          </group>
          
          <group string="Estado y Errores" col="2" attrs="{'invisible': [('state', '!=', 'error')]}">
            <field name="error_message" readonly="1" nolabel="1" colspan="2"/>
            <field name="last_response_date" readonly="1"/>
          </group>
          
          <!-- Documentos: facturas subidas + documentos adjuntos; se pueden subir más PDFs -->
          <group string="Documentos" colspan="2">
            <group colspan="2">
              <button name="action_anadir_documento" string="Subir documento (PDF u otro)" type="object"
                      class="oe_highlight" icon="fa-upload"
                      help="Añadir un nuevo documento PDF u otro archivo al expediente. Las facturas subidas en la pestaña Facturas también aparecen aquí."/>
            </group>
            <field name="documento_ids" nolabel="1" colspan="2">
              <tree create="0" delete="1" string="Documentos y facturas">
                <field name="name"/>
                <field name="tipo_documento" optional="show"/>
                <field name="file_size" optional="show"/>
                <field name="create_date" optional="show"/>
                <field name="datas" filename="name" widget="binary" readonly="1"/>
              </tree>
              <form>
                <sheet>
                  <group>
                    <field name="name"/>
                    <field name="mimetype"/>
                    <field name="file_size"/>
                    <field name="create_date"/>
                  </group>
                  <group string="Archivo">
                    <field name="datas" filename="name" widget="binary"/>
                  </group>
                  <!-- Campos invisibles para determinar tipo de archivo -->
                  <field name="is_xml" invisible="1"/>
                  <field name="is_pdf" invisible="1"/>
                  <!-- Vista Previa PDF -->
                  <group string="Vista Previa PDF" colspan="2" attrs="{'invisible': [('is_pdf', '=', False)]}">
                    <field name="datas" filename="name" widget="pdf_viewer" 
                           readonly="1" nolabel="1" colspan="2"
                           options="{'disable_zoom': false, 'disable_scroll': false}"/>
                  </group>
                  <!-- Vista Previa XML -->
                  <group string="Vista Previa XML" colspan="2" attrs="{'invisible': [('is_xml', '=', False)]}">
                    <button name="action_preview_xml" string="Abrir XML en nueva pestaña" 
                            type="object" 
                            class="oe_highlight"
                            icon="fa-external-link"/>
                    <field name="xml_content_text" nolabel="1" readonly="1" 
                           widget="text" colspan="2"
                           placeholder="Cargando contenido XML..."
                           options="{'wrap': false}"/>
                  </group>
                </sheet>
              </form>
            </field>
          </group>

          <notebook>
            <page string="Líneas">
              <field name="line_ids" limit="40">
                <tree editable="bottom" default_order="item_number">
                  <field name="expediente_id" column_invisible="1"/>
                  <field name="item_number"/>
                  <field name="factura_id" string="Factura" domain="[('expediente_id', '=', expediente_id)]"/>
                  <field name="partida"/>
                  <field name="descripcion"/>
                  <field name="unidades" sum="Total"/>
                  <field name="bultos" sum="Total"/>
                  <field name="peso_bruto" sum="Total"/>
                  <field name="peso_neto" sum="Total"/>
                  <field name="precio_unitario"/>
                  <field name="descuento"/>
                  <field name="valor_linea" sum="Total"/>
                  <field name="verificacion_estado"
                         decoration-success="verificacion_estado == 'correcto'"
                         decoration-info="verificacion_estado == 'verificado'"
                         decoration-warning="verificacion_estado == 'sugerido'"
                         decoration-muted="verificacion_estado == 'pendiente'"
                         decoration-danger="verificacion_estado == 'corregido'"/>
                  <field name="verificacion_detalle"/>
                  <field name="pais_origen"/>
                </tree>
              </field>
            </page>
            <page string="Totales">
              <group>
                <field name="valor_factura"/>
                <field name="moneda"/>
                <field name="pais_origen"/>
                <field name="pais_destino"/>
              </group>
            </page>
            <page string="Documentos Requeridos" name="documentos_requeridos">
              <group>
                <button name="action_consultar_taric_manual" 
                        string="Consultar TARIC" 
                        type="object"
                        class="oe_highlight"
                        icon="fa-search"
                        help="Consulta la API TARIC de la UE para obtener los documentos requeridos por cada partida arancelaria del expediente. Actualiza todos los códigos según las líneas actuales y elimina los que ya no existen."/>
              </group>
              <field name="documento_requerido_ids">
                <tree editable="bottom" create="0" delete="1">
                  <field name="expediente_id" column_invisible="1"/>
                  <field name="factura_id" string="Factura" domain="[('expediente_id', '=', expediente_id)]"/>
                  <field name="partida_arancelaria" readonly="1"/>
                  <field name="codigo_documento" readonly="1"/>
                  <field name="name" readonly="1"/>
                  <field name="mandatory" widget="boolean_toggle"/>
                  <field name="estado" widget="badge" 
                         decoration-success="estado == 'verificado'"
                         decoration-info="estado == 'subido'"
                         decoration-warning="estado == 'pendiente'"/>
                  <field name="documento_subido" filename="documento_filename"/>
                  <field name="documento_filename" invisible="1"/>
                  <field name="fecha_subida" readonly="1"/>
                  <field name="subido_por" readonly="1"/>
                  <field name="description" invisible="1"/>
                  <field name="notas"/>
                  <button name="action_view_documento_detalle" 
                          string="Ver Detalles" 
                          type="object"
                          class="oe_link"
                          icon="fa-eye"
                          title="Ver información completa y previsualización del documento"/>
                </tree>
                <form>
                  <sheet>
                    <group>
                      <group>
                        <field name="expediente_id" readonly="1"/>
                        <field name="factura_id" string="Factura" domain="[('expediente_id', '=', expediente_id)]"/>
                        <field name="partida_arancelaria" readonly="1"/>
                        <field name="codigo_documento" readonly="1"/>
                        <field name="name" readonly="1"/>
                        <field name="mandatory"/>
                        <field name="estado"/>
                      </group>
                      <group>
                        <field name="description" readonly="1"/>
                        <field name="documento_subido" filename="documento_filename"/>
                        <field name="documento_filename"/>
                        <field name="fecha_subida" readonly="1"/>
                        <field name="subido_por" readonly="1"/>
                        <field name="notas"/>
                      </group>
                    </group>
                  </sheet>
                </form>
              </field>
            </page>
            <page string="Incidencias" name="incidencias">
              <field name="incidencia_ids">
                <tree>
                  <field name="name"/>
                  <field name="tipo_incidencia"/>
                  <field name="codigo_incidencia"/>
                  <field name="titulo"/>
                  <field name="prioridad" widget="badge"/>
                  <field name="state" widget="badge"/>
                  <field name="fecha_incidencia"/>
                  <field name="dias_pendiente"/>
                  <field name="origen"/>
                </tree>
              </field>
            </page>

            <page string="Bandeja / Técnico">
              <group>
                <field name="bandeja_last_num"/>
                <field name="last_response_date" readonly="1"/>
              </group>
            </page>
          </notebook>
        </sheet>
        <div class="oe_chatter">
                <field name="message_follower_ids" widget="mail_followers"/>
                <field name="activity_ids" widget="mail_activity"/>
                <field name="message_ids" widget="mail_thread"/>
            </div>
      </form>
    </field>
  </record>

  <!-- Vista Search -->
  <record id="view_aduana_expediente_search" model="ir.ui.view">
    <field name="name">aduana.expediente.search</field>
    <field name="model">aduana.expediente</field>
    <field name="arch" type="xml">
      <search string="Buscar Expedientes Aduaneros">
        <field name="name"/>
        <field name="mrn"/>
        <field name="remitente"/>
        <field name="consignatario"/>
        <field name="matricula"/>
        <field name="msoft_codigo"/>
        <filter string="Pendientes" name="pending" domain="[('state', 'in', ('draft', 'predeclared', 'presented', 'accepted', 'released'))]"/>
        <filter string="Con Error" name="error" domain="[('state', '=', 'error')]"/>
        <filter string="Cerrados" name="closed" domain="[('state', '=', 'closed')]"/>
        <filter string="Exportación" name="export_filter" domain="[('direction', '=', 'export')]"/>
        <filter string="Importación" name="import_filter" domain="[('direction', '=', 'import')]"/>
        <filter string="Hoy" name="today_filter" domain="[('create_date', '>=', datetime.combine(context_today(), time.min)), ('create_date', '&lt;=', datetime.combine(context_today(), time.max))]"/>
        <filter string="Con Incidencias Pendientes" name="with_pending_incidents" domain="[('incidencias_pendientes_count', '&gt;', 0)]"/>
        <group expand="0" string="Agrupar por">
          <filter string="Matrícula" name="group_by_matricula" context="{'group_by': 'matricula'}" icon="fa-truck"/>
          <filter string="Estado" name="group_by_state" context="{'group_by': 'state'}"/>
          <filter string="Sentido" name="group_by_direction" context="{'group_by': 'direction'}"/>
          <filter string="Remitente" name="group_by_remitente" context="{'group_by': 'remitente'}"/>
          <filter string="Fecha Prevista" name="group_by_fecha_prevista" context="{'group_by': 'fecha_prevista'}"/>
          <filter string="Oficina" name="group_by_oficina" context="{'group_by': 'oficina'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- Vista Kanban -->
  <record id="view_aduana_expediente_kanban" model="ir.ui.view">
    <field name="name">aduana.expediente.kanban</field>
    <field name="model">aduana.expediente</field>
    <field name="arch" type="xml">
      <kanban default_group_by="state" class="o_kanban_small_column">
        <field name="name"/>
        <field name="state"/>
        <field name="direction"/>
        <field name="mrn"/>
        <field name="remitente"/>
        <field name="fecha_prevista"/>
        <templates>
          <t t-name="kanban-box">
            <div class="oe_kanban_card oe_kanban_global_click">
              <div class="oe_kanban_content">
                <div class="o_kanban_record_top">
                  <div class="o_kanban_record_headings">
                    <strong class="o_kanban_record_title">
                      <field name="name"/>
                    </strong>
                  </div>
                </div>
                <div class="o_kanban_record_body">
                  <field name="direction"/>
                  <div t-if="record.mrn.raw_value">
                    <strong>MRN:</strong> <field name="mrn"/>
                  </div>
                  <div>
                    <field name="remitente"/>
                  </div>
                  <div t-if="record.fecha_prevista.raw_value">
                    <field name="fecha_prevista"/>
                  </div>
                </div>
              </div>
            </div>
          </t>
        </templates>
      </kanban>
    </field>
  </record>

  <!-- Acción de servidor para procesar facturas múltiples -->
  <record id="action_procesar_facturas_multi" model="ir.actions.server">
    <field name="name">Procesar Facturas</field>
    <field name="model_id" ref="model_aduana_expediente"/>
    <field name="binding_model_id" ref="model_aduana_expediente"/>
    <field name="binding_view_types">list</field>
    <field name="state">code</field>
    <field name="code">
if records:
    action = records.action_procesar_facturas_multi()
    </field>
  </record>

  <!-- Acción para Subir Facturas (desde Expediciones) -->
  <record id="action_subir_facturas_desde_expedientes" model="ir.actions.act_window">
    <field name="name">Subir Facturas</field>
    <field name="res_model">aduana.carga.masiva</field>
    <field name="view_mode">tree,form</field>
    <field name="target">current</field>
  </record>

  <!-- Acción -->
  <record id="action_aduana_expediente" model="ir.actions.act_window">
    <field name="name">Expedientes Aduaneros</field>
    <field name="res_model">aduana.expediente</field>
    <field name="view_mode">tree,kanban,form</field>
    <field name="context">{'search_default_pending': 1}</field>
    <field name="search_view_id" ref="view_aduana_expediente_search"/>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        No hay expedientes registrados
      </p>
      <p>
        Crea un nuevo expediente o usa el botón "Subir Facturas" para crear múltiples expedientes desde facturas PDF.
      </p>
    </field>
  </record>

  <!-- Vista Popup para Detalle de Documento Requerido -->
  <record id="view_aduana_expediente_documento_requerido_popup" model="ir.ui.view">
    <field name="name">aduana.expediente.documento.requerido.popup</field>
    <field name="model">aduana.expediente.documento.requerido</field>
    <field name="arch" type="xml">
      <form string="Detalle del Documento Requerido">
        <sheet>
          <group>
            <group>
              <field name="expediente_id" readonly="1"/>
              <field name="partida_arancelaria" readonly="1"/>
              <field name="codigo_documento" readonly="1"/>
              <field name="name" readonly="1"/>
              <field name="mandatory" readonly="1"/>
              <field name="estado" readonly="1"/>
            </group>
            <group>
              <field name="fecha_subida" readonly="1"/>
              <field name="subido_por" readonly="1"/>
              <field name="documento_filename" readonly="1"/>
            </group>
          </group>
          
          <group string="Descripción Completa" colspan="2">
            <field name="description" readonly="1" nolabel="1" widget="text" 
                   placeholder="No hay descripción disponible"
                   colspan="2"/>
          </group>
          
          <group string="Notas" colspan="2" attrs="{'invisible': [('notas', '=', False)]}">
            <field name="notas" readonly="1" nolabel="1" widget="text" colspan="2"/>
          </group>
          
          <!-- Campos invisibles para determinar tipo de archivo -->
          <field name="is_pdf" invisible="1"/>
          <field name="is_image" invisible="1"/>
          
          <!-- Vista Previa PDF -->
          <group string="Vista Previa del Documento" colspan="2" 
                 attrs="{'invisible': [('documento_subido', '=', False)]}">
            <group colspan="2" attrs="{'invisible': [('is_pdf', '=', False)]}">
              <field name="documento_subido" filename="documento_filename" 
                     widget="pdf_viewer" 
                     readonly="1" nolabel="1" colspan="2"
                     options="{'disable_zoom': false, 'disable_scroll': false}"/>
            </group>
            <group colspan="2" attrs="{'invisible': [('is_image', '=', False)]}">
              <field name="documento_subido" filename="documento_filename" 
                     widget="image" 
                     readonly="1" nolabel="1" colspan="2"
                     options="{'preview_image': true}"/>
            </group>
            <group colspan="2" attrs="{'invisible': ['|', ('is_pdf', '=', True), ('is_image', '=', True)]}">
              <div class="alert alert-info" role="alert" colspan="2">
                <p>El documento está subido pero no se puede previsualizar en este formato.</p>
                <p><strong>Nombre del archivo:</strong> <field name="documento_filename" readonly="1" nolabel="1"/></p>
              </div>
            </group>
          </group>
          
          <group string="Documento no subido" colspan="2" 
                 attrs="{'invisible': [('documento_subido', '!=', False)]}">
            <div class="alert alert-warning" role="alert">
              <p>Este documento aún no ha sido subido.</p>
            </div>
          </group>
        </sheet>
      </form>
    </field>
  </record>

  <!-- Vista tree standalone para líneas de expediente (p. ej. desde "Ver Líneas" de una factura) -->
  <record id="view_aduana_expediente_line_tree" model="ir.ui.view">
    <field name="name">aduana.expediente.line.tree</field>
    <field name="model">aduana.expediente.line</field>
    <field name="arch" type="xml">
      <tree string="Líneas de mercancía" default_order="item_number" editable="bottom">
        <field name="item_number"/>
        <field name="partida"/>
        <field name="descripcion"/>
        <field name="unidades" sum="Total"/>
        <field name="bultos" sum="Total"/>
        <field name="peso_bruto" sum="Total"/>
        <field name="peso_neto" sum="Total"/>
        <field name="precio_unitario"/>
        <field name="descuento"/>
        <field name="valor_linea" sum="Total"/>
        <field name="verificacion_estado"/>
        <field name="pais_origen"/>
      </tree>
    </field>
  </record>

  <!-- Menú -->
  <menuitem id="menu_aduanas_root" name="Aduanas"/>
  <menuitem id="menu_aduanas_expedientes" name="Expediciones"
            parent="menu_aduanas_root" action="action_aduana_expediente" sequence="10"/>

</odoo>
